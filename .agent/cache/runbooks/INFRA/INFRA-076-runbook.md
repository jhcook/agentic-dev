# INFRA-076: Create binary release using end-user license

## State

ACCEPTED

## Goal Description

The `release.sh` script currently generates a `.agent/templates/license_header.txt` file in the target repository if the user provides a custom license file.
The goal of this story is to utilize this `license_header.txt` file (specifically the first line, representing the copyright string) to dynamically annotate project files.

**Important clarification:**

1. Markdown objects generated by the user (ADRs, Stories, Runbooks, Plans) already have a `## Copyright` section at the bottom containing `{{ COPYRIGHT_HEADER }}` inside their respective templates in `.agent/templates/`. The templating engine handles replacing this string natively when the object is created.
2. Therefore, the core remaining work is restricted to annotating **source code files** (Python) and **Journeys** (YAML) that lack native templating support during generation, as well as fixing the internal `license_header.txt` logic to output that copyright string effectively so the native templating works seamlessly.

## Proposed Changes

### `agent/core/utils.py`

Update the existing utility functions to correctly parse the copyright string.

#### [MODIFY] `get_copyright_header()`

- Add logic to read `.agent/templates/license_header.txt` if it exists.
- Extract the first line of the file (which should hold the copyright notice).
- Fallback to the default "Copyright 2026 Justin Cook" if the file does not exist or is empty.
- *Note: This will automatically fix the Markdown file generation since those `new-*` commands natively call `.replace("{{ COPYRIGHT_HEADER }}", get_copyright_header())`.*

### `agent/commands/license.py`

Create a new standalone command to iterate over the codebase and apply the copyright header to Python and YAML files.

#### [NEW] `apply_license(target_dir: str = ".")`

- A new CLI command: `agent apply-license`.
- Iterate through all `.py` and `.yaml` files in the target directory (respecting `.gitignore` exclusions to avoid `.venv`, `cache`, etc.).
- For each file, check if the copyright header (from `get_copyright_header()`) is already present on the first line.
- If missing, format the copyright header using `#` and prepend it to the file.
- Register this command in `agent/main.py`.

### `agent/commands/implement.py`

Ensure files generated by the AI receive the license header immediately.

#### [MODIFY] `implement()`

- After the LLM generates/modifies code, invoke the logic from `apply_license()` on the specific files that were created or modified within that session, ensuring `agent implement` produces compliant source code.

## Verification Plan

### Automated Tests

- Unit test for `get_copyright_header()`:
  - Test the default scenario where `license_header.txt` does not exist.
  - Test the scenario where `license_header.txt` exists and contains a custom string on the first line.
- Unit test for the licensing logic:
  - Create temporary `.py` and `.yaml` files.
  - Assert that running the licensing logic prepends `# Copyright <string>`.
  - Assert that running it twice does not duplicate the header.

### Manual Verification

- Create a `.agent/templates/license_header.txt` containing `Copyright 2026 Custom Corp`.
- Run `agent new-story TEST-001` and verify the bottom of the `.md` file says `Copyright 2026 Custom Corp`.
- Create a dummy Python file `test.py` with no header.
- Run `agent apply-license`.
- Verify `test.py` now has `# Copyright 2026 Custom Corp` at the top.
