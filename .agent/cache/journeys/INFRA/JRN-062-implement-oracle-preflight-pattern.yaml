# Journey: JRN-062
# Title: Implement Oracle Preflight Pattern
# State: COMMITTED

actor: "Agentic Developer / Framework Maintainer"
description: "Preflight checks use dynamic tool-driven retrieval (Oracle Pattern) across all providers to prevent hallucinations. Includes NotebookLM MCP routing and local vector DB fallback."

steps:
  - action: "User initiates `agent preflight` on a staged branch."
    system_response: "The system assembles the governance panel, prioritizing tools over static context."
    assertions:
      - "The initial prompt does not contain <adrs>, <rules>, or global <instructions>."
      - "The diff context is reduced to -U3."
      - "The agent system instructions strictly forbid out-of-domain evaluation."

  - action: "System creates/syncs a NotebookLM notebook."
    system_response: "System ensures NotebookLM has an up-to-date 'agentic-dev' notebook containing ADRs and MDC files."
    assertions:
      - "The framework actively executes notebooklm-mcp tools (like notebook_add_text) to push local rules."

  - action: "Agent needs architectural context for a changed file."
    system_response: "Agent utilizes the `read_adr`, `read_file`, or `search_codebase` tools to retrieve context."
    assertions:
      - "The agent retrieves context via tools and cites the retrieved sources (`Source: [Exact file path or ADR ID]`)."
      - "If NotebookLM MCP is available, the agent queries it first."
      - "If NotebookLM MCP is unavailable, the agent queries the local vector database."

  - action: "Agent evaluates the change against retrieved context."
    system_response: "Agent produces a VERDICT and FINDINGS."
    assertions:
      - "Findings without explicit tool-verified citations are discarded."
      - "Preflight output strict format is followed."

acceptance_criteria:
  - "AC-1: Reduced diff context to -U3."
  - "AC-2: Removed global context from initial prompt."
  - "AC-3: Legacy mode `--legacy-context` preserves original behavior."
  - "AC-4: Scoped agent instructions."
  - "AC-5: Verified citation requirement."
  - "AC-6: Tool availability across all providers."
  - "AC-7: Local Vector DB fallback available."
  - "AC-8: Preflight test confirms tool usage."
  - "AC-9: Oracle pattern functions across Anthropic, Vertex, Gemini."
  - "AC-10: Notion Sync Awareness check before Oracle preflight."
  - "AC-11: NotebookLM Routing priority."
  - "AC-12: NotebookLM Automated Sync adds ADRs/Rules/Caches."

error_paths:
  - trigger: "Tool-retrieved finding is missing a citation."
    expected: "The finding is rejected from the final output."
  
edge_cases:
  - scenario: "A project has no ADRs or rules defined."
    expected: "Oracle pattern executes quickly and passes without forcing tool calls."

auth_context:
  roles: []
  permissions: []

data_state:
  data_classification: internal
  preconditions: []
  postconditions: []

implementation:
  routes:
    - "agent preflight"
  files:
    - ".agent/src/agent/commands/check.py"
    - ".agent/src/agent/core/adk/agents.py"
    - ".agent/src/agent/core/context.py"
    - ".agent/src/agent/core/governance.py"
    - ".agent/src/agent/core/mcp/client.py"
    - ".agent/src/agent/db/journey_index.py"
    - ".agent/src/agent/sync/notion.py"
    - ".agent/src/agent/sync/notebooklm.py"
  tests:
    - ".agent/tests/commands/test_check_commands.py"
    - ".agent/tests/db/test_journey_index.py"
    - ".agent/tests/e2e/test_e2e_governance.py"
    - ".agent/tests/e2e/test_e2e_interactive.py"
    - ".agent/tests/integration/test_notebooklm_sync.py"
    - ".agent/tests/integration/test_python_agent.py"

linked_stories: 
  - "INFRA-074"
linked_adrs: []
depends_on: []
